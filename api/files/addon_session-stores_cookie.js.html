<!DOCTYPE html>
<html>
  <head>
    <title>addon/session-stores/cookie.js - The Ember Simple Auth API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/vendor/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/vendor/css/github.css">
    <link rel="stylesheet" href="../assets/vendor/css/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <script src="../assets/vendor/js/jquery.min.js"></script>
    <script src="../assets/vendor/js/bootstrap.min.js"></script>
    <script src="../assets/vendor/js/highlight.pack.js"></script>
  </head>
  <body>
    <header class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="../index.html">The Ember Simple Auth API</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/simplabs/ember-simple-auth"><i class="fa fa-github"></i> Source Code</a></li>
            <li><p class="navbar-text project-version"><a href="https://github.com/simplabs/ember-simple-auth/releases/tag/1.1.0-beta.3"><span class="label label-primary">1.1.0-beta.3</span></a></p></li>
          </ul>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="row">
        <div id="sidebar" class="col-sm-3">
          <div class="row">
            <div id="classes" class="col-sm-12">
              <h4>Classes</h4>
              <ul class="list-unstyled">
                  <li><a href="../classes/AdaptiveStore.html">AdaptiveStore</a></li>
                  <li><a href="../classes/ApplicationRouteMixin.html">ApplicationRouteMixin</a></li>
                  <li><a href="../classes/AuthenticatedRouteMixin.html">AuthenticatedRouteMixin</a></li>
                  <li><a href="../classes/BaseAuthenticator.html">BaseAuthenticator</a></li>
                  <li><a href="../classes/BaseAuthorizer.html">BaseAuthorizer</a></li>
                  <li><a href="../classes/BaseStore.html">BaseStore</a></li>
                  <li><a href="../classes/Configuration.html">Configuration</a></li>
                  <li><a href="../classes/CookieStore.html">CookieStore</a></li>
                  <li><a href="../classes/DataAdapterMixin.html">DataAdapterMixin</a></li>
                  <li><a href="../classes/DeviseAuthenticator.html">DeviseAuthenticator</a></li>
                  <li><a href="../classes/DeviseAuthorizer.html">DeviseAuthorizer</a></li>
                  <li><a href="../classes/EphemeralStore.html">EphemeralStore</a></li>
                  <li><a href="../classes/LocalStorageStore.html">LocalStorageStore</a></li>
                  <li><a href="../classes/OAuth2BearerAuthorizer.html">OAuth2BearerAuthorizer</a></li>
                  <li><a href="../classes/OAuth2PasswordGrantAuthenticator.html">OAuth2PasswordGrantAuthenticator</a></li>
                  <li><a href="../classes/SessionService.html">SessionService</a></li>
                  <li><a href="../classes/ToriiAuthenticator.html">ToriiAuthenticator</a></li>
                  <li><a href="../classes/UnauthenticatedRouteMixin.html">UnauthenticatedRouteMixin</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div id="main" class="col-sm-9">
          <h1 class="file-heading">File: addon/session-stores/cookie.js</h1>
          
          <div class="file">
              <pre class="code prettyprint linenums">
          import Ember from &#x27;ember&#x27;;
          import BaseStore from &#x27;./base&#x27;;
          import objectsAreEqual from &#x27;../utils/objects-are-equal&#x27;;
          
          const { RSVP, computed, run: { next } } = Ember;
          
          /**
            Session store that persists data in a cookie.
          
            By default the cookie session store uses a session cookie that expires and is
            deleted when the browser is closed. The cookie expiration period can be
            configured by setting the
            {{#crossLink &quot;CookieStore/cookieExpirationTime:property&quot;}}{{/crossLink}}
            property. This can be used to implement &quot;remember me&quot; functionality that will
            either store the session persistently or in a session cookie depending on
            whether the user opted in or not:
          
            &#x60;&#x60;&#x60;js
            // app/controllers/login.js
            export default Ember.Controller.extend({
              rememberMe: false,
          
              _rememberMeChanged: Ember.observer(&#x27;rememberMe&#x27;, function() {
                const expirationTime = this.get(&#x27;rememberMe&#x27;) ? (14 * 24 * 60 * 60) : null;
                this.set(&#x27;session.store.cookieExpirationTime&#x27;, expirationTime);
              }
            });
            &#x60;&#x60;&#x60;
          
            __In order to keep multiple tabs/windows of an application in sync, this
            store has to periodically (every 500ms) check the cookie for changes__ as
            there are no events for cookie changes that the store could subscribe to. If
            the application does not need to make sure all session data is deleted when
            the browser is closed, the
            {{#crossLink &quot;LocalStorageStore&quot;}}&#x60;localStorage&#x60; session store{{/crossLink}}
            should be used.
          
            @class CookieStore
            @module ember-simple-auth/session-stores/cookie
            @extends BaseStore
            @public
          */
          export default BaseStore.extend({
            /**
              The domain to use for the cookie, e.g., &quot;example.com&quot;, &quot;.example.com&quot;
              (which includes all subdomains) or &quot;subdomain.example.com&quot;. If not
              explicitly set, the cookie domain defaults to the domain the session was
              authneticated on.
          
              @property cookieDomain
              @type String
              @default null
              @public
            */
            cookieDomain: null,
          
            /**
              The name of the cookie.
          
              @property cookieName
              @type String
              @default ember_simple_auth:session
              @public
            */
            cookieName: &#x27;ember_simple_auth:session&#x27;,
          
            /**
              The expiration time for the cookie in seconds. A value of &#x60;null&#x60; will make
              the cookie a session cookie that expires and gets deleted when the browser
              is closed.
          
              @property cookieExpirationTime
              @default null
              @type Integer
              @public
            */
            cookieExpirationTime: null,
          
            _secureCookies: window.location.protocol === &#x27;https:&#x27;,
          
            _syncDataTimeout: null,
          
            _renewExpirationTimeout: null,
          
            _isPageVisible: computed(function() {
              const visibilityState = document.visibilityState || &#x27;visible&#x27;;
              return visibilityState === &#x27;visible&#x27;;
            }).volatile(),
          
            init() {
              this._super(...arguments);
          
              next(() =&gt; {
                this._syncData().then(() =&gt; {
                  this._renewExpiration();
                });
              });
            },
          
            /**
              Persists the &#x60;data&#x60; in the cookie.
          
              @method persist
              @param {Object} data The data to persist
              @return {Ember.RSVP.Promise} A promise that resolves when the data has successfully been persisted and rejects otherwise.
              @public
            */
            persist(data) {
              this._lastData = data;
              data           = JSON.stringify(data || {});
              let expiration = this._calculateExpirationTime();
              this._write(data, expiration);
              return RSVP.resolve();
            },
          
            /**
              Returns all data currently stored in the cookie as a plain object.
          
              @method restore
              @return {Ember.RSVP.Promise} A promise that resolves with the data currently persisted in the store when the data has been restored successfully and rejects otherwise.
              @public
            */
            restore() {
              let data = this._read(this.cookieName);
              if (Ember.isEmpty(data)) {
                return RSVP.resolve({});
              } else {
                return RSVP.resolve(JSON.parse(data));
              }
            },
          
            /**
              Clears the store by deleting the cookie.
          
              @method clear
              @return {Ember.RSVP.Promise} A promise that resolves when the store has been cleared successfully and rejects otherwise.
              @public
            */
            clear() {
              this._write(null, 0);
              this._lastData = {};
              return RSVP.resolve();
            },
          
            _read(name) {
              let value = document.cookie.match(new RegExp(&#x60;${name}=([^;]+)&#x60;)) || [];
              return decodeURIComponent(value[1] || &#x27;&#x27;);
            },
          
            _calculateExpirationTime() {
              let cachedExpirationTime = this._read(&#x60;${this.cookieName}:expiration_time&#x60;);
              cachedExpirationTime     = !!cachedExpirationTime ? new Date().getTime() + cachedExpirationTime * 1000 : null;
              return !!this.cookieExpirationTime ? new Date().getTime() + this.cookieExpirationTime * 1000 : cachedExpirationTime;
            },
          
            _write(value, expiration) {
              let path        = &#x27;; path=/&#x27;;
              let domain      = Ember.isEmpty(this.cookieDomain) ? &#x27;&#x27; : &#x60;; domain=${this.cookieDomain}&#x60;;
              let expires     = Ember.isEmpty(expiration) ? &#x27;&#x27; : &#x60;; expires=${new Date(expiration).toUTCString()}&#x60;;
              let secure      = !!this._secureCookies ? &#x27;;secure&#x27; : &#x27;&#x27;;
              document.cookie = &#x60;${this.cookieName}=${encodeURIComponent(value)}${domain}${path}${expires}${secure}&#x60;;
              if (expiration !== null) {
                let cachedExpirationTime = this._read(&#x60;${this.cookieName}:expiration_time&#x60;);
                document.cookie = &#x60;${this.cookieName}:expiration_time=${encodeURIComponent(this.cookieExpirationTime || cachedExpirationTime)}${domain}${path}${expires}${secure}&#x60;;
              }
            },
          
            _syncData() {
              return this.restore().then((data) =&gt; {
                if (!objectsAreEqual(data, this._lastData)) {
                  this._lastData = data;
                  this.trigger(&#x27;sessionDataUpdated&#x27;, data);
                }
                if (!Ember.testing) {
                  Ember.run.cancel(this._syncDataTimeout);
                  this._syncDataTimeout = Ember.run.later(this, this._syncData, 500);
                }
              });
            },
          
            _renew() {
              return this.restore().then((data) =&gt; {
                if (!Ember.isEmpty(data) &amp;&amp; data !== {}) {
                  data           = Ember.typeOf(data) === &#x27;string&#x27; ? data : JSON.stringify(data || {});
                  let expiration = this._calculateExpirationTime();
                  this._write(data, expiration);
                }
              });
            },
          
            _renewExpiration() {
              if (!Ember.testing) {
                Ember.run.cancel(this._renewExpirationTimeout);
                this._renewExpirationTimeout = Ember.run.later(this, this._renewExpiration, 60000);
              }
              if (this.get(&#x27;_isPageVisible&#x27;)) {
                return this._renew();
              } else {
                return RSVP.resolve();
              }
            }
          });
          
              </pre>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript" charset="utf-8">
      function fixLeadingWhitespace(codeBlock) {
        var text = $(codeBlock).text();
        var lines = text.split('\n');
        var minLeadindSpaces = text.length;
        $.each(lines.slice(1), function(i, line) {
          var match = line.match(/^\s+/);
          if (match) {
            minLeadindSpaces = Math.min(match[0].length);
          }
        });
        var regexp = new RegExp('^\\s{' + minLeadindSpaces + '}');
        var fixedLines = lines.slice(0, 1).concat($.map(lines.slice(1), function(line) {
          return line.replace(regexp, '');
        }));
        $(codeBlock).text(fixedLines.join('\n'));
      }

      $(document).ready(function() {
        $('pre code').each(function(i, codeBlock) {
          fixLeadingWhitespace(codeBlock);
          hljs.highlightBlock(codeBlock);
        });
      });
    </script>
  </body>
</html>
